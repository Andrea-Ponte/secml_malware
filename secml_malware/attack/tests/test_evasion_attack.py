"""
.. module:: MalConTestSuite
	:synopsis: MalConv basic unit tests

.. moduleauthor:: Luca Demetrio <luca.demetrio@dibris.unige.it>
"""

import unittest
import torch
from secml.array import CArray
from secml_malware.attack.c_kreuk_evasion import CKreukEvasion
from secml_malware.attack.c_suciu_evasion import CSuciuEvasion

from secml_malware.utils.malconv_test_base import MalConvBaseTests
from secml_malware.attack import CHeaderMalConvEvasion, CPaddingMalconvEvasion
from secml.data import CDataset


class EvasionMalConvTestSuite(MalConvBaseTests):
	def setUp(self):
		super(EvasionMalConvTestSuite, self).setUp()
		self.classifier.load_pretrained_model(self.ember_path)
		self.surrogate_classifier.load_pretrained_model(self.surrogate_path)
		self.Y = self.classifier.predict(CArray(self.X), return_decision_function=False)

	def test_whitebox_ember_model_attack_random_init(self):
		attack = CHeaderMalConvEvasion(
			self.classifier,
			is_debug=True,
			random_init=True,
		)
		y_pred, _, _, _ = attack.run(self.X, self.Y)
		n_old_y_malw = sum(self.Y == 1)
		n_false_negative = sum(self.Y == 0)
		n_new_detected_malw = sum(y_pred == 1) - n_false_negative
		self.assertNotEqual(
			n_old_y_malw,
			n_new_detected_malw,
			msg="Evasion achieved: {}/{}".format(
				self.Y.shape[0] - n_new_detected_malw, self.Y.shape[0]
			),
		)

	def test_whitebox_ember_model_attack_no_random_init(self):
		attack = CHeaderMalConvEvasion(
			self.classifier,
			is_debug=True,
			random_init=False,
		)
		y_pred, scores, _, _ = attack.run(self.X, self.Y)
		n_old_y_malw = sum(self.Y == 1)
		n_false_negative = sum(self.Y == 0)
		n_new_detected_malw = sum(y_pred == 1) - n_false_negative
		self.assertNotEqual(
			n_old_y_malw,
			n_new_detected_malw,
			msg="Evasion achieved: {}/{}".format(
				self.Y.shape[0] - n_new_detected_malw, self.Y.shape[0]
			),
		)

	def test_padding_whitebox_ember_model_attack(self):
		padding_attack = CPaddingMalconvEvasion(
			self.classifier,
			1000,
			random_init=True,
			is_debug=True
		)
		y_pred, _, _, _ = padding_attack.run(self.X, self.Y)
		n_old_y_malw = sum(self.Y == 1)
		n_false_negative = sum(self.Y == 0)
		n_new_detected_malw = sum(y_pred == 1) - n_false_negative
		self.assertNotEqual(
			n_old_y_malw,
			n_new_detected_malw,
			msg="Evasion achieved: {}/{}".format(
				self.Y.shape[0] - n_new_detected_malw, self.Y.shape[0]
			),
		)

	def test_kreuk_whitebox_attack(self):
		kreuk_attack = CKreukEvasion(
			self.classifier,
			how_many_padding_bytes=1000,
			epsilon=0.03,
			iterations=50,
			is_debug=True
		)
		y_pred, _, _, _ = kreuk_attack.run(self.X, self.Y)
		n_old_y_malw = sum(self.Y == 1)
		n_false_negative = sum(self.Y == 0)
		n_new_detected_malw = sum(y_pred == 1) - n_false_negative
		self.assertNotEqual(
			n_old_y_malw,
			n_new_detected_malw,
			msg="Evasion achieved: {}/{}".format(
				self.Y.shape[0] - n_new_detected_malw, self.Y.shape[0]
			),
		)

	def test_kreuk_whitebox_no_slack_attack_p2(self):
		kreuk_attack = CKreukEvasion(
			self.classifier,
			how_many_padding_bytes=1000,
			epsilon=0.03,
			iterations=50,
			is_debug=True,
			compute_slack=False,
			p_norm=2
		)
		y_pred, _, _, _ = kreuk_attack.run(self.X, self.Y)
		n_old_y_malw = sum(self.Y == 1)
		n_false_negative = sum(self.Y == 0)
		n_new_detected_malw = sum(y_pred == 1) - n_false_negative
		self.assertNotEqual(
			n_old_y_malw,
			n_new_detected_malw,
			msg="Evasion achieved: {}/{}".format(
				self.Y.shape[0] - n_new_detected_malw, self.Y.shape[0]
			),
		)
	def test_kreuk_whitebox_attack_p2(self):
		kreuk_attack = CKreukEvasion(
			self.classifier,
			how_many_padding_bytes=1000,
			epsilon=0.03,
			iterations=50,
			is_debug=True,
			compute_slack=True,
			p_norm=2
		)
		y_pred, _, _, _ = kreuk_attack.run(self.X, self.Y)
		n_old_y_malw = sum(self.Y == 1)
		n_false_negative = sum(self.Y == 0)
		n_new_detected_malw = sum(y_pred == 1) - n_false_negative
		self.assertNotEqual(
			n_old_y_malw,
			n_new_detected_malw,
			msg="Evasion achieved: {}/{}".format(
				self.Y.shape[0] - n_new_detected_malw, self.Y.shape[0]
			),
		)

	def test_kreuk_whitebox_no_slack_attack(self):
		kreuk_attack = CKreukEvasion(
			self.classifier,
			how_many_padding_bytes=1000,
			epsilon=0.03,
			iterations=50,
			is_debug=True,
			compute_slack=False
		)
		y_pred, _, _, _ = kreuk_attack.run(self.X, self.Y)
		n_old_y_malw = sum(self.Y == 1)
		n_false_negative = sum(self.Y == 0)
		n_new_detected_malw = sum(y_pred == 1) - n_false_negative
		self.assertNotEqual(
			n_old_y_malw,
			n_new_detected_malw,
			msg="Evasion achieved: {}/{}".format(
				self.Y.shape[0] - n_new_detected_malw, self.Y.shape[0]
			),
		)

	def test_suciu_appending_whitebox_attack(self):
		kreuk_attack = CSuciuEvasion(
			self.classifier,
			how_many_padding_bytes=1000,
			epsilon=0.03,
			is_debug=True
		)
		y_pred, _, _, _ = kreuk_attack.run(self.X, self.Y)
		n_old_y_malw = sum(self.Y == 1)
		n_false_negative = sum(self.Y == 0)
		n_new_detected_malw = sum(y_pred == 1) - n_false_negative
		self.assertNotEqual(
			n_old_y_malw,
			n_new_detected_malw,
			msg="Evasion achieved: {}/{}".format(
				self.Y.shape[0] - n_new_detected_malw, self.Y.shape[0]
			),
		)

	def test_suciu_appending_whitebox_no_slack_attack(self):
		kreuk_attack = CSuciuEvasion(
			self.classifier,
			how_many_padding_bytes=1000,
			epsilon=0.03,
			is_debug=True,
			compute_slack=False
		)
		y_pred, _, _, _ = kreuk_attack.run(self.X, self.Y)
		n_old_y_malw = sum(self.Y == 1)
		n_false_negative = sum(self.Y == 0)
		n_new_detected_malw = sum(y_pred == 1) - n_false_negative
		self.assertNotEqual(
			n_old_y_malw,
			n_new_detected_malw,
			msg="Evasion achieved: {}/{}".format(
				self.Y.shape[0] - n_new_detected_malw, self.Y.shape[0]
			),
		)


if __name__ == "__main__":
	unittest.main()
